generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Story {
  id             String          @id @default(cuid())
  title          String
  description    String?
  coverImage     String?
  published      Boolean         @default(false)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  aiPrompt       String?
  archivedAt     DateTime?
  featuredAt     DateTime?
  generatedBy    String?
  status         StoryStatus     @default(DRAFT)
  theme          String?
  tier           Int             @default(1)
  releaseAt      DateTime?
  Character      Character[]
  readerSessions ReaderSession[]
  scenes         Scene[]
}

model Scene {
  id                String             @id @default(cuid())
  title             String
  content           String
  isStart           Boolean            @default(false)
  isEnding          Boolean            @default(false)
  order             Int                @default(0)
  storyId           String
  characterId       String?
  isBranchPoint     Boolean            @default(false)
  choicesFrom       Choice[]           @relation("FromScene")
  choicesTo         Choice[]           @relation("ToScene")
  interactionEvents InteractionEvent[]
  ReaderSession     ReaderSession[]
  character         Character?         @relation(fields: [characterId], references: [id])
  story             Story              @relation(fields: [storyId], references: [id], onDelete: Cascade)
  sceneViews        SceneView[]

  @@index([storyId])
  @@index([characterId])
}

model Choice {
  id              String        @id @default(cuid())
  text            String
  order           Int           @default(0)
  fromSceneId     String
  toSceneId       String
  archetypeTarget String?
  generatedAt     DateTime?
  generatedFor    String?
  isGenerated     Boolean       @default(false)
  fromScene       Scene         @relation("FromScene", fields: [fromSceneId], references: [id], onDelete: Cascade)
  toScene         Scene         @relation("ToScene", fields: [toSceneId], references: [id], onDelete: Cascade)
  choiceEvents    ChoiceEvent[]

  @@index([fromSceneId])
  @@index([toSceneId])
  @@index([archetypeTarget])
}

model Character {
  id          String  @id @default(cuid())
  name        String
  description String?
  avatarUrl   String?
  storyId     String
  Story       Story   @relation(fields: [storyId], references: [id], onDelete: Cascade)
  scenes      Scene[]

  @@index([storyId])
}

model ReaderProfile {
  id               String          @id @default(cuid())
  visitorId        String          @unique
  archetype        String
  scores           Json
  quizAnswers      Json?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  completionCount  Int             @default(0)
  email            String?
  notifyNewStories Boolean         @default(false)
  tier             Int             @default(1)
  ReaderSession    ReaderSession[]

  @@index([visitorId])
  @@index([archetype])
  @@index([tier])
}

model ReaderSession {
  id                String             @id @default(cuid())
  startedAt         DateTime           @default(now())
  completedAt       DateTime?
  visitorId         String?
  storyId           String
  currentSceneId    String?
  profileId         String?
  choiceEvents      ChoiceEvent[]
  interactionEvents InteractionEvent[]
  Scene             Scene?             @relation(fields: [currentSceneId], references: [id])
  ReaderProfile     ReaderProfile?     @relation(fields: [profileId], references: [id])
  story             Story              @relation(fields: [storyId], references: [id], onDelete: Cascade)
  sceneViews        SceneView[]

  @@index([visitorId])
  @@index([storyId])
  @@index([profileId])
}

model ChoiceEvent {
  id        String        @id @default(cuid())
  chosenAt  DateTime      @default(now())
  sessionId String
  choiceId  String
  choice    Choice        @relation(fields: [choiceId], references: [id], onDelete: Cascade)
  session   ReaderSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([choiceId])
  @@index([chosenAt])
}

model SceneView {
  id          String        @id @default(cuid())
  sessionId   String
  sceneId     String
  enteredAt   DateTime      @default(now())
  exitedAt    DateTime?
  timeSpentMs Int?
  scene       Scene         @relation(fields: [sceneId], references: [id], onDelete: Cascade)
  session     ReaderSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([sceneId])
  @@index([enteredAt])
}

model InteractionEvent {
  id        String        @id @default(cuid())
  sessionId String
  sceneId   String
  eventType String
  timestamp DateTime      @default(now())
  metadata  Json?
  scene     Scene         @relation(fields: [sceneId], references: [id], onDelete: Cascade)
  session   ReaderSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([sceneId])
  @@index([eventType])
}

model StoryGeneration {
  id         String   @id @default(cuid())
  prompt     String
  model      String
  tokensUsed Int?
  costCents  Int?
  durationMs Int?
  success    Boolean
  error      String?
  storyId    String?
  createdAt  DateTime @default(now())

  @@index([createdAt])
  @@index([success])
}

enum StoryStatus {
  DRAFT
  ACTIVE
  FEATURED
  ARCHIVED
}