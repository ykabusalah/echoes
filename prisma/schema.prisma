// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============== STORY STRUCTURE ==============

enum StoryStatus {
  DRAFT
  FEATURED
  ARCHIVED
}

model Story {
  id          String      @id @default(cuid())
  title       String
  description String?
  coverImage  String?
  published   Boolean     @default(false)
  status      StoryStatus @default(DRAFT)
  theme       String?
  generatedBy String?
  aiPrompt    String?
  featuredAt  DateTime?
  archivedAt  DateTime?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  characters     Character[]
  scenes         Scene[]
  readerSessions ReaderSession[]
}

model Character {
  id          String  @id @default(cuid())
  name        String
  description String?
  avatarUrl   String?

  storyId String
  story   Story   @relation(fields: [storyId], references: [id], onDelete: Cascade)
  scenes  Scene[]

  @@index([storyId])
}

model Scene {
  id            String  @id @default(cuid())
  title         String
  content       String
  isStart       Boolean @default(false)
  isEnding      Boolean @default(false)
  isBranchPoint Boolean @default(false)
  order         Int     @default(0)

  storyId     String
  story       Story      @relation(fields: [storyId], references: [id], onDelete: Cascade)
  characterId String?
  character   Character? @relation(fields: [characterId], references: [id], onDelete: SetNull)

  choicesFrom Choice[] @relation("FromScene")
  choicesTo   Choice[] @relation("ToScene")

  readerSessions    ReaderSession[]
  sceneViews        SceneView[]
  interactionEvents InteractionEvent[]

  @@index([storyId])
  @@index([characterId])
}

model Choice {
  id    String @id @default(cuid())
  text  String
  order Int    @default(0)

  fromSceneId String
  fromScene   Scene  @relation("FromScene", fields: [fromSceneId], references: [id], onDelete: Cascade)
  toSceneId   String
  toScene     Scene  @relation("ToScene", fields: [toSceneId], references: [id], onDelete: Cascade)

  // Personalization fields
  archetypeTarget String?
  isGenerated     Boolean   @default(false)
  generatedFor    String?
  generatedAt     DateTime?

  choiceEvents ChoiceEvent[]

  @@index([fromSceneId])
  @@index([toSceneId])
  @@index([archetypeTarget])
}

// ============== READER PROFILES & QUIZ ==============

model ReaderProfile {
  id            String   @id @default(cuid())
  visitorId     String   @unique
  archetype     String
  scores        Json
  quizAnswers   Json?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  sessions ReaderSession[]

  @@index([visitorId])
  @@index([archetype])
}

// ============== READER ANALYTICS ==============

model ReaderSession {
  id          String    @id @default(cuid())
  startedAt   DateTime  @default(now())
  completedAt DateTime?
  visitorId   String?

  storyId        String
  story          Story   @relation(fields: [storyId], references: [id], onDelete: Cascade)
  currentSceneId String?
  currentScene   Scene?  @relation(fields: [currentSceneId], references: [id], onDelete: SetNull)
  profileId      String?
  profile        ReaderProfile? @relation(fields: [profileId], references: [id], onDelete: SetNull)

  choiceEvents      ChoiceEvent[]
  sceneViews        SceneView[]
  interactionEvents InteractionEvent[]

  @@index([storyId])
  @@index([visitorId])
  @@index([profileId])
}

model ChoiceEvent {
  id       String   @id @default(cuid())
  chosenAt DateTime @default(now())

  sessionId String
  session   ReaderSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  choiceId  String
  choice    Choice        @relation(fields: [choiceId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([choiceId])
  @@index([chosenAt])
}

// ============== DETAILED ANALYTICS ==============

model SceneView {
  id          String    @id @default(cuid())
  sessionId   String
  sceneId     String
  enteredAt   DateTime  @default(now())
  exitedAt    DateTime?
  timeSpentMs Int?

  session ReaderSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  scene   Scene         @relation(fields: [sceneId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([sceneId])
  @@index([enteredAt])
}

model InteractionEvent {
  id        String   @id @default(cuid())
  sessionId String
  sceneId   String
  eventType String
  timestamp DateTime @default(now())
  metadata  Json?

  session ReaderSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  scene   Scene         @relation(fields: [sceneId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([sceneId])
  @@index([eventType])
}

// ============== AI GENERATION LOGGING ==============

model StoryGeneration {
  id         String   @id @default(cuid())
  prompt     String
  model      String
  tokensUsed Int?
  costCents  Int?
  durationMs Int?
  success    Boolean
  error      String?
  storyId    String?
  createdAt  DateTime @default(now())

  @@index([createdAt])
  @@index([success])
}